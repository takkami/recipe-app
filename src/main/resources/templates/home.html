<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RecipeApp</title>
    <meta name="description" content="sample text">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">

    <!-- CSRFトークン -->
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

    <!-- CSS -->
    <link rel="stylesheet" href="/assets/css/sanitize.css">
    <link rel="stylesheet" href="/assets/css/style.css">
</head>
<body class="page-home">

<section id="loading">
    <div class="loading">
        <div class="pack"></div>
        <div class="fuels">
            <div></div><div></div><div></div><div></div>
        </div>
    </div>
</section>

<div class="container">
    <!-- Top Navbar -->
    <header class="top-navbar">
        <button class="sidebar-toggle" onclick="toggleSidebar()" aria-label="メニューを開く">
            <span></span>
        </button>
        <div class="title">RecipeApp</div>
        <div class="header-right">
            <!-- ヘッダー右側 -->
            <div class="user-info" sec:authorize="isAuthenticated()">
                <span th:text="'ようこそ、' + ${#authentication.name} + 'さん'">ユーザー名</span>
            </div>
            <div class="header-actions" sec:authorize="isAuthenticated()">
                <form th:action="@{/logout}" method="post" style="display:inline;">
                    <button type="submit" class="logout-btn">ログアウト</button>
                </form>
            </div>

        </div>
    </header>

    <!-- Sidebar -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-content">
            <div class="sidebar-header">
                <button class="sidebar-close" onclick="toggleSidebar()" aria-label="メニューを閉じる">
                    ✕
                </button>
            </div>
            <ul>
                <li>
                    <a href="/home" class="home-button">
                        <img src="/images/icons/home.svg" alt="ホーム" />
                        <span>ホーム</span>
                    </a>
                </li>
                <li>
                    <a href="/home">
                        <img src="/images/icons/book.svg" alt="レシピ一覧" />
                        <span>レシピ一覧</span>
                    </a>
                </li>
                <li>
                    <a href="/recipes/favorites">
                        <img src="/images/icons/heart.svg" alt="お気に入り">
                        <span>お気に入り</span>
                    </a>
                </li>
                <li>
                    <img src="/images/icons/category.svg" alt="カテゴリ" />
                    <span>カテゴリ</span>
                </li>
                <li>
                    <img src="/images/icons/user.svg" alt="ユーザー情報" />
                    <span>ユーザー情報</span>
                </li>
                <li>
                    <img src="/images/icons/interrogation.svg" alt="ヘルプ" />
                    <span>ヘルプ</span>
                </li>
                <li class="bottom">
                    <img src="/images/icons/settings.svg" alt="設定" />
                    <span>設定</span>
                </li>
                <li class="bottom" sec:authorize="isAuthenticated()">
                    <form th:action="@{/logout}" method="post" style="margin:0;">
                        <button type="submit" class="logout-sidebar-btn">
                            <img src="/images/icons/logout.svg" alt="ログアウト" />
                            <span>ログアウト</span>
                        </button>
                    </form>
                </li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="main-toolbar">
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="レシピ名やカテゴリで検索..." />
                <span class="search-icon">
                <img src="/images/icons/search.svg" alt="検索" />
              </span>
            </div>
            <div class="add-button-container">
                <a href="/recipes/new" class="add-button">
                    <span class="add-text">追加</span>
                    <img src="/images/icons/add.svg" alt="追加">
                </a>
            </div>
        </div>
        <div class="section-header">
            <div class="section-title">
                <h2 th:if="${favoritesPage != null and favoritesPage}" th:text="'お気に入りレシピ一覧 (' + ${#lists.size(recipes)} + '件)'">お気に入り</h2>
                <h2 th:if="${categoryName != null}" th:text="'カテゴリ：' + ${categoryName} + ' (' + ${#lists.size(recipes)} + '件)'">カテゴリ</h2>
                <h2 th:if="${favoritesPage == null and categoryName == null}" th:text="'すべてのレシピ一覧 (' + ${#lists.size(recipes)} + '件)'">すべてのレシピ</h2>
            </div>
        </div>

        <!-- 成功・エラーメッセージ表示 -->
        <div th:if="${successMessage}" class="flash-message success-message">
            <span th:text="${successMessage}"></span>
        </div>
        <div th:if="${errorMessage}" class="flash-message error-message">
            <span th:text="${errorMessage}"></span>
        </div>

        <p th:if="${#lists.isEmpty(recipes)}" class="no-recipes-message">レシピが見つかりませんでした。</p>
        <p id="noResultsMessage" class="no-results-message" style="display: none;">検索条件に一致するレシピが見つかりませんでした。</p>

        <!-- レシピカード表示 -->
        <div class="card-list" th:if="${not #lists.isEmpty(recipes)}">
            <section class="card" th:each="recipe : ${recipes}" th:attr="data-recipe-id=${recipe.id}">
                <div class="card-menu">
                    <button class="menu-toggle" aria-label="メニューを開く">︙</button>
                    <div class="menu-content">
                        <form th:action="@{'/recipes/edit/' + ${recipe.id}}" method="get" style="margin:0;">
                            <button type="submit" class="edit-button">編集</button>
                        </form>
                        <button type="button" class="delete-button" th:attr="data-recipe-id=${recipe.id}">削除</button>
                    </div>
                </div>
                <div class="card-image-wrapper">
                    <img th:if="${recipe.imagePath != null}" th:src="@{${recipe.imagePath}}" alt="レシピ画像" class="card-image" loading="lazy" />
                    <img th:if="${recipe.imagePath == null}" th:src="@{/images/no-image.png}" alt="レシピ画像なし" class="card-no-image" loading="lazy" />
                    <div class="card-overlay">
                        <h2 th:text="${recipe.title}" class="overlay-title">レシピ名</h2>
                        <button class="favorite-toggle" th:attr="data-id=${recipe.id}" aria-label="お気に入りに追加">
                            <img class="heart-image" th:src="${recipe.favorite} ? '/images/icons/heart_active.svg' : '/images/icons/heart_off.svg'" alt="お気に入り" />
                        </button>
                    </div>
                </div>
                <div class="card-body">
                  <span th:each="cat : ${recipe.categories}">
                     <a th:href="@{'/recipes/category/' + ${cat}}"
                        th:text="${cat}"
                        th:classappend="'category-tag ' + ${cat}"
                        title="このカテゴリのレシピを表示">
                        カテゴリ
                    </a>
                  </span>
                </div>
            </section>
        </div>
    </main>
</div>

<script>
    // 検索機能の改善
    const searchInput = document.getElementById('searchInput');
    const recipeCards = document.querySelectorAll('.card');

    // 正規化関数（カタカナ→ひらがな、小文字化、全角→半角）
    function normalizeText(str) {
      return str
        .toLowerCase()
        .normalize("NFKC")
        .replace(/[ァ-ン]/g, s => String.fromCharCode(s.charCodeAt(0) - 0x60));
    }

    // リアルタイム検索機能
    function performSearch() {
        const keywordRaw = searchInput.value.trim();
        const keyword = normalizeText(keywordRaw);

        const noResultsMessage = document.getElementById('noResultsMessage');
        const noRecipesMessage = document.querySelector('.no-recipes-message');
        let visibleCardCount = 0;

        // 検索キーワードが空の場合は全て表示
        if (keyword === '') {
            recipeCards.forEach(card => {
                card.style.display = '';
                visibleCardCount++;
            });
            noResultsMessage.style.display = 'none';
            return;
        }

        recipeCards.forEach(card => {
            const titleElement = card.querySelector('h2');
            const categoryElements = card.querySelectorAll('.category-tag');

            const title = normalizeText(titleElement ? titleElement.textContent : '');
            const categories = Array.from(categoryElements).map(el =>
                normalizeText(el ? el.textContent : '')
            ).join(' ');

            const titleMatch = title.includes(keyword);
            const categoryMatch = categories.includes(keyword);

            if (titleMatch || categoryMatch) {
                card.style.display = '';
                visibleCardCount++;
            } else {
                card.style.display = 'none';
            }
        });

        // 検索結果メッセージの表示制御
        if (visibleCardCount === 0) {
            noResultsMessage.style.display = 'block';
            if (noRecipesMessage) {
                noRecipesMessage.style.display = 'none';
            }
        } else {
            noResultsMessage.style.display = 'none';
        }
    }

    // Enterキーでの検索実行
    searchInput.addEventListener('keydown', function (event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            performSearch();
        }
    });

    // リアルタイム検索（入力中）
    let searchTimeout;
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            performSearch();
        }, 300); // 300ms後に検索実行（連続入力時のパフォーマンス向上）
    });

    // サイドバー機能
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.toggle('active');
    }

    function checkScreenSize() {
        const sidebar = document.getElementById('sidebar');
        const toggleBtn = document.querySelector('.sidebar-toggle');

        if (window.innerWidth > 768) {
            // デスクトップサイズの場合、サイドバーを閉じる
            sidebar.classList.remove('active');
        }
    }

    document.addEventListener('click', function (e) {
        const sidebar = document.getElementById('sidebar');
        const toggleBtn = document.querySelector('.sidebar-toggle');
        const closeBtn = document.querySelector('.sidebar-close');
        const sidebarContent = document.querySelector('.sidebar-content');

        // モバイルサイズでのみ外側クリックでサイドバーを閉じる
        if (window.innerWidth <= 768) {
            if (!sidebarContent.contains(e.target) &&
                !toggleBtn.contains(e.target) &&
                !closeBtn.contains(e.target)) {
                sidebar.classList.remove('active');
            }
        }
    });

    // ESCキーでサイドバーを閉じる
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const sidebar = document.getElementById('sidebar');
            if (sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
            }
        }
    });

    // 画面サイズ変更時の処理
    window.addEventListener('resize', checkScreenSize);

    // 初回読み込み時の処理
    document.addEventListener('DOMContentLoaded', checkScreenSize);

    // カードメニュー機能
    document.addEventListener('click', function(event) {
        const menuToggles = document.querySelectorAll('.menu-toggle');
        const menuContents = document.querySelectorAll('.menu-content');

        // メニュートグルがクリックされた場合
        if (event.target.classList.contains('menu-toggle')) {
            event.stopPropagation();

            // 他のメニューを閉じる
            menuContents.forEach(menu => {
                if (menu !== event.target.nextElementSibling) {
                    menu.style.display = 'none';
                }
            });

            // クリックされたメニューをトグル
            const menuContent = event.target.nextElementSibling;
            if (menuContent.style.display === 'flex') {
                menuContent.style.display = 'none';
            } else {
                menuContent.style.display = 'flex';
            }
        } else {
            // メニュー以外がクリックされた場合は全メニューを閉じる
            menuContents.forEach(menu => {
                menu.style.display = 'none';
            });
        }
    });

    // お気に入りトグル処理
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".favorite-toggle").forEach(button => {
            button.addEventListener("click", async (event) => {
                event.preventDefault();

                const recipeId = button.getAttribute("data-id");

                try {
                    const response = await fetch(`/recipes/${recipeId}/toggleFavorite`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        credentials: 'same-origin'
                    });

                    if (!response.ok) {
                        throw new Error("お気に入り切り替え失敗 HTTP: " + response.status);
                    }

                    const isFavorite = await response.json();
                    const img = button.querySelector("img");
                    img.src = isFavorite ? "/images/icons/heart_active.svg" : "/images/icons/heart_off.svg";

                    // アクセシビリティ: aria-label の更新
                    button.setAttribute('aria-label',
                        isFavorite ? 'お気に入りから削除' : 'お気に入りに追加'
                    );

                } catch (error) {
                    console.error("Toggle Favorite Error:", error);
                    alert("お気に入りの切り替えに失敗しました。もう一度お試しください。");
                }
            });
        });
    });

    // 削除ボタン処理（改善版）
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".delete-button").forEach(button => {
            button.addEventListener("click", async (event) => {
                event.preventDefault();

                const recipeId = button.getAttribute("data-recipe-id");
                const cardElement = document.querySelector(`[data-recipe-id="${recipeId}"]`);
                const recipeName = cardElement ? cardElement.querySelector('.overlay-title').textContent : 'このレシピ';

                if (!confirm(`「${recipeName}」を削除してもよろしいですか？\nこの操作は取り消せません。`)) {
                    return;
                }

                // 削除中の視覚的フィードバック
                const originalText = button.textContent;
                button.textContent = '削除中...';
                button.disabled = true;

                try {
                    const response = await fetch(`/recipes/${recipeId}/delete`, {
                        method: "DELETE",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        credentials: 'same-origin'
                    });

                    if (!response.ok) {
                        throw new Error("削除に失敗しました HTTP: " + response.status);
                    }

                    // 削除成功時、カードをDOMから削除
                    if (cardElement) {
                        cardElement.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                        cardElement.style.opacity = '0';
                        cardElement.style.transform = 'scale(0.95)';

                        setTimeout(() => {
                            cardElement.remove();

                            // カードが0件になった場合のメッセージ表示
                            const remainingCards = document.querySelectorAll('.card[style*="display: none"], .card:not([style*="display: none"])');
                            const visibleCards = Array.from(remainingCards).filter(card =>
                                !card.style.display || card.style.display !== 'none'
                            );

                            if (visibleCards.length === 0) {
                                const cardList = document.querySelector('.card-list');
                                if (cardList) {
                                    cardList.style.display = 'none';
                                }

                                // 既存のメッセージがない場合のみ追加
                                if (!document.querySelector('.no-recipes-message')) {
                                    const noRecipeMessage = document.createElement('p');
                                    noRecipeMessage.className = 'no-recipes-message';
                                    noRecipeMessage.textContent = 'レシピが見つかりませんでした。';
                                    document.querySelector('.main-content').appendChild(noRecipeMessage);
                                }
                            }

                            // 件数表示の更新
                            updateRecipeCount();
                        }, 300);
                    }

                } catch (error) {
                    console.error("Delete Recipe Error:", error);
                    alert("レシピの削除に失敗しました。もう一度お試しください。");

                    // エラー時はボタンを元に戻す
                    button.textContent = originalText;
                    button.disabled = false;
                }
            });
        });
    });

    // 件数表示の更新
    function updateRecipeCount() {
        const visibleCards = document.querySelectorAll('.card:not([style*="display: none"])');
        const sectionTitle = document.querySelector('.section-title h2');

        if (sectionTitle) {
            const titleText = sectionTitle.textContent;
            const countMatch = titleText.match(/\((\d+)件\)/);

            if (countMatch) {
                const newTitle = titleText.replace(/\(\d+件\)/, `(${visibleCards.length}件)`);
                sectionTitle.textContent = newTitle;
            }
        }
    }

    // ローディング機能
    window.addEventListener('load', () => {
        const loader = document.getElementById('loading');
        const url = new URL(window.location.href);
        const hasLoadingParam = url.searchParams.get('loading') === 'true';

        if (hasLoadingParam) {
            if (loader) {
                loader.style.display = 'flex';

                setTimeout(() => {
                    loader.style.display = 'none';
                }, 1500);

                // loading=true を削除（履歴は残すが画面はリロードしない）
                url.searchParams.delete('loading');
                window.history.replaceState({}, document.title, url.toString());
            }
        } else {
            if (loader) {
                loader.remove(); // 二度目以降はDOMごと削除（ちらつき防止）
            }
        }
    });

    // フラッシュメッセージの自動非表示
    document.addEventListener('DOMContentLoaded', function() {
        const flashMessages = document.querySelectorAll('.flash-message');
        flashMessages.forEach(message => {
            setTimeout(() => {
                message.style.opacity = '0';
                message.style.transform = 'translateY(-10px)';
                setTimeout(() => {
                    if (message.parentNode) {
                        message.parentNode.removeChild(message);
                    }
                }, 300);
            }, 4000); // 4秒後に非表示
        });
    });

    // パフォーマンス最適化: 画像の遅延読み込み対応
    if ('IntersectionObserver' in window) {
        const imageObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    if (img.dataset.src) {
                        img.src = img.dataset.src;
                        img.removeAttribute('data-src');
                        observer.unobserve(img);
                    }
                }
            });
        });

        // 既存の loading="lazy" 属性のある画像を対象に
        document.querySelectorAll('img[loading="lazy"]').forEach(img => {
            imageObserver.observe(img);
        });
    }
</script>

</body>
</html>