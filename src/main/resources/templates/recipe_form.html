<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title th:text="${recipe.id} != null ? 'ãƒ¬ã‚·ãƒ”ç·¨é›†' : 'ãƒ¬ã‚·ãƒ”è¿½åŠ '">ãƒ¬ã‚·ãƒ”è¿½åŠ </title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="/assets/css/sanitize.css">
    <link rel="stylesheet" href="/assets/css/style.css">
</head>
<body class="page-add">
<div class="container">
    <header class="top-navbar">
        <button class="sidebar-toggle" onclick="toggleSidebar()" aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ã">
            <span></span>
        </button>
        <div class="title">Recipin'</div>
        <div class="header-right">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼å³å´ -->
            <div class="user-info" sec:authorize="isAuthenticated()">
                <span th:text="'ã‚ˆã†ã“ãã€' + ${#authentication.name} + 'ã•ã‚“'">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</span>
            </div>
            <div class="header-actions" sec:authorize="isAuthenticated()">
                <form th:action="@{/logout}" method="post" style="display:inline;">
                    <button type="submit" class="logout-btn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                </form>
            </div>
        </div>
    </header>

    <!-- Sidebar -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-content">
            <div class="sidebar-header">
                <button class="sidebar-close" onclick="toggleSidebar()" aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹">
                    âœ•
                </button>
            </div>
            <ul>
                <li>
                    <a href="/home" class="home-button">
                        <img src="/images/icons/home.svg" alt="ãƒ›ãƒ¼ãƒ " />
                        <span>ãƒ›ãƒ¼ãƒ </span>
                    </a>
                </li>
                <li>
                    <a href="/home">
                        <img src="/images/icons/book.svg" alt="ãƒ¬ã‚·ãƒ”ä¸€è¦§" />
                        <span>ãƒ¬ã‚·ãƒ”ä¸€è¦§</span>
                    </a>
                </li>
                <li>
                    <a href="/recipes/favorites">
                        <img src="/images/icons/heart.svg" alt="ãŠæ°—ã«å…¥ã‚Š">
                        <span>ãŠæ°—ã«å…¥ã‚Š</span>
                    </a>
                </li>
                <li>
                    <a href="/home">
                        <img src="/images/icons/category.svg" alt="ã‚«ãƒ†ã‚´ãƒªä¸€è¦§" />
                        <span>ã‚«ãƒ†ã‚´ãƒªä¸€è¦§</span>
                    </a>
                </li>
                <li>
                    <div class="menu-item" onclick="showUserInfo()">
                        <img src="/images/icons/user.svg" alt="ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±" />
                        <span>ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±</span>
                    </div>
                </li>
                <li>
                    <div class="menu-item" onclick="showHelp()">
                        <img src="/images/icons/interrogation.svg" alt="ãƒ˜ãƒ«ãƒ—" />
                        <span>ãƒ˜ãƒ«ãƒ—</span>
                    </div>
                </li>
                <li class="bottom">
                    <div class="menu-item" onclick="showSettings()">
                        <img src="/images/icons/settings.svg" alt="è¨­å®š" />
                        <span>è¨­å®š</span>
                    </div>
                </li>
                <li class="bottom" sec:authorize="isAuthenticated()">
                    <form th:action="@{/logout}" method="post" style="margin:0;">
                        <button type="submit" class="logout-sidebar-btn">
                            <img src="/images/icons/logout.svg" alt="ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ" />
                            <span>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</span>
                        </button>
                    </form>
                </li>
            </ul>
        </div>
    </nav>

    <main class="main-content">
        <div class="section-header">
            <div class="section-title">
                <h1 th:text="${recipe.id} != null ? 'ãƒ¬ã‚·ãƒ”ã‚’ç·¨é›†' : 'ãƒ¬ã‚·ãƒ”ã‚’è¿½åŠ '">ãƒ¬ã‚·ãƒ”ã‚’è¿½åŠ </h1>
            </div>
            <div class="add-button-container">
                <a href="/home" class="add-button back-button">
                    <span class="add-text">æˆ»ã‚‹</span>
                    <img src="/images/icons/back.svg" alt="æˆ»ã‚‹">
                </a>
            </div>
        </div>

        <div class="form-container">
            <!-- ãŠæ°—ã«å…¥ã‚Šãƒœã‚¿ãƒ³ã‚’å³ä¸Šã«é…ç½®ï¼ˆä¿®æ­£ç‰ˆï¼‰ -->
            <button type="button" class="favorite-toggle favorite-top-right" onclick="toggleFavorite(this)" aria-label="ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ ">
                <img id="favorite-icon"
                     th:src="${recipe.favorite} ? '/images/icons/heart_active.svg' : '/images/icons/heart_off.svg'"
                     th:classappend="${recipe.favorite} ? ' selected' : ''"
                     alt="ãŠæ°—ã«å…¥ã‚Š"
                     class="heart-image">
            </button>

            <!-- ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º -->
            <div th:if="${successMessage}" class="flash-message success-message">
                <span th:text="${successMessage}"></span>
            </div>
            <div th:if="${warningMessage}" class="flash-message warning-message">
                <span th:text="${warningMessage}"></span>
            </div>
            <div th:if="${errorMessage}" class="flash-message error-message">
                <span th:text="${errorMessage}"></span>
            </div>

            <form th:action="@{${recipe.id} != null ? '/recipes/update' : '/recipes/new'}" th:object="${recipe}" method="post" enctype="multipart/form-data" id="recipe-form">
                <!-- IDï¼ˆç·¨é›†æ™‚ã®ã¿ï¼‰ -->
                <input type="hidden" th:if="${recipe.id}" th:name="id" th:value="${recipe.id}" />

                <!-- ãŠæ°—ã«å…¥ã‚Šã®å€¤ã‚’ä¿æŒã™ã‚‹éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
                <input type="hidden" th:name="favorite" th:value="${recipe.favorite}" id="favorite-input" />

                <div class="form-group">
                    <label for="title">ã‚¿ã‚¤ãƒˆãƒ« <span style="color: red;">*</span></label>
                    <input type="text" id="title" th:name="title" th:value="${recipe.title}" required maxlength="100">
                </div>

                <div class="form-group">
                    <label for="image">ãƒ¬ã‚·ãƒ”ç”»åƒ</label>
                    <div class="file-input-wrapper">
                        <input type="file" id="image" name="image" accept="image/jpeg,image/jpg,image/png,image/gif,image/webp" />
                        ğŸ“· ç”»åƒã‚’é¸æŠ
                    </div>

                    <!-- ç·¨é›†æ™‚ã®æ—¢å­˜ç”»åƒè¡¨ç¤ºã¨å‰Šé™¤ -->
                    <div th:if="${recipe.imagePath}" class="image-preview-container" id="current-image-wrapper">
                        <span class="current-image-label">ç¾åœ¨ã®ç”»åƒ:</span>
                        <img th:src="@{${recipe.imagePath}}" alt="ç¾åœ¨ã®ç”»åƒ" class="image-preview" id="current-image" />
                        <button type="button" class="image-remove" onclick="removeCurrentImage()">Ã—</button>
                        <input type="hidden" name="deleteCurrentImage" id="deleteCurrentImage" value="false" />
                    </div>

                    <!-- æ–°ã—ã„ç”»åƒã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
                    <div class="image-preview-container" id="preview-container" style="display: none;">
                        <span class="current-image-label">é¸æŠã—ãŸç”»åƒ:</span>
                        <img id="image-preview" class="image-preview" alt="ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼" />
                        <button type="button" class="image-remove" onclick="removeImagePreview()">Ã—</button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="ingredients">ææ–™</label>
                    <textarea id="ingredients" th:name="ingredients" th:text="${recipe.ingredients}" placeholder="ä¾‹ï¼š&#10;ãƒ»ç‰ã­ã 1å€‹&#10;ãƒ»ã«ã‚“ã˜ã‚“ 1æœ¬&#10;ãƒ»ã˜ã‚ƒãŒã„ã‚‚ 2å€‹"></textarea>
                </div>

                <div class="form-group">
                    <label for="instructions">ä½œã‚Šæ–¹</label>
                    <textarea id="instructions" th:name="instructions" th:text="${recipe.instructions}" placeholder="ä¾‹ï¼š&#10;1. ç‰ã­ãã‚’è–„åˆ‡ã‚Šã«ã™ã‚‹&#10;2. ãƒ•ãƒ©ã‚¤ãƒ‘ãƒ³ã§ç‚’ã‚ã‚‹&#10;3. å¡©èƒ¡æ¤’ã§å‘³ä»˜ã‘ã™ã‚‹"></textarea>
                </div>

                <div class="form-group">
                    <label for="reference">å‚è€ƒå‹•ç”»ãƒ»ã‚µã‚¤ãƒˆï¼ˆURLï¼‰</label>
                    <input type="url" id="reference" th:name="reference" th:value="${recipe.reference}" placeholder="https://example.com">
                </div>

                <div class="form-group">
                    <label for="category-select">ã‚«ãƒ†ã‚´ãƒªï¼ˆæœ€å¤§3ã¤ã¾ã§é¸æŠå¯ï¼‰</label>
                    <div class="category-selector">
                        <div class="custom-select">
                            <div class="select-trigger" onclick="toggleDropdown()" tabindex="0">
                                <span id="selected-categories">ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„</span>
                                <span class="arrow">â–¼</span>
                            </div>
                            <div class="select-options" id="category-options">
                                <label class="option"><input type="checkbox" name="categories" value="å’Œé£Ÿ" th:checked="${recipe.categories != null and recipe.categories.contains('å’Œé£Ÿ')}"> å’Œé£Ÿ</label>
                                <label class="option"><input type="checkbox" name="categories" value="æ´‹é£Ÿ" th:checked="${recipe.categories != null and recipe.categories.contains('æ´‹é£Ÿ')}"> æ´‹é£Ÿ</label>
                                <label class="option"><input type="checkbox" name="categories" value="ä¸­è¯" th:checked="${recipe.categories != null and recipe.categories.contains('ä¸­è¯')}"> ä¸­è¯</label>
                                <label class="option"><input type="checkbox" name="categories" value="éººé¡" th:checked="${recipe.categories != null and recipe.categories.contains('éººé¡')}"> éººé¡</label>
                                <label class="option"><input type="checkbox" name="categories" value="ã‚¹ãƒ¼ãƒ—" th:checked="${recipe.categories != null and recipe.categories.contains('ã‚¹ãƒ¼ãƒ—')}"> ã‚¹ãƒ¼ãƒ—</label>
                                <label class="option"><input type="checkbox" name="categories" value="ã‚µãƒ©ãƒ€" th:checked="${recipe.categories != null and recipe.categories.contains('ã‚µãƒ©ãƒ€')}"> ã‚µãƒ©ãƒ€</label>
                                <label class="option"><input type="checkbox" name="categories" value="ãŠã¤ã¾ã¿" th:checked="${recipe.categories != null and recipe.categories.contains('ãŠã¤ã¾ã¿')}"> ãŠã¤ã¾ã¿</label>
                                <label class="option"><input type="checkbox" name="categories" value="ãƒ‡ã‚¶ãƒ¼ãƒˆ" th:checked="${recipe.categories != null and recipe.categories.contains('ãƒ‡ã‚¶ãƒ¼ãƒˆ')}"> ãƒ‡ã‚¶ãƒ¼ãƒˆ</label>
                                <label class="option"><input type="checkbox" name="categories" value="æ™‚çŸ­" th:checked="${recipe.categories != null and recipe.categories.contains('æ™‚çŸ­')}"> æ™‚çŸ­</label>
                                <label class="option"><input type="checkbox" name="categories" value="ãƒ˜ãƒ«ã‚·ãƒ¼" th:checked="${recipe.categories != null and recipe.categories.contains('ãƒ˜ãƒ«ã‚·ãƒ¼')}"> ãƒ˜ãƒ«ã‚·ãƒ¼</label>
                                <label class="option"><input type="checkbox" name="categories" value="ãã®ä»–" th:checked="${recipe.categories != null and recipe.categories.contains('ãã®ä»–')}"> ãã®ä»–</label>
                            </div>
                        </div>
                        <!-- ã‚«ãƒ†ã‚´ãƒªåˆ¶é™ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
                        <div id="category-limit-message" class="category-limit-message" style="display: none;">
                            ã‚«ãƒ†ã‚´ãƒªã®é¸æŠã¯3ã¤ã¾ã§ã§ã™ã€‚
                        </div>
                        <div class="selected-tags" id="selected-tags"></div>
                    </div>
                </div>

                <div class="button-wrapper">
                    <button type="submit" class="submit-button" th:text="${recipe.id} != null ? 'æ›´æ–°' : 'ç™»éŒ²'" id="submit-btn">ç™»éŒ²</button>
                </div>
            </form>
        </div>
    </main>
</div>

<script>
    // ãƒ•ã‚©ãƒ¼ãƒ ç”»é¢ç”¨ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ
    class FormDarkModeManager {
        constructor() {
            this.init();
        }

        init() {
            // åˆæœŸè¨­å®šã®èª­ã¿è¾¼ã¿
            this.loadSettings();
            // è¨­å®šå¤‰æ›´ã®ç›£è¦–
            this.watchStorageChanges();
        }

        loadSettings() {
            const darkMode = localStorage.getItem('darkMode') === 'true';
            const compactView = localStorage.getItem('compactView') === 'true';

            if (darkMode) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
        }

        watchStorageChanges() {
            // localStorage ã®å¤‰æ›´ã‚’ç›£è¦–
            window.addEventListener('storage', (e) => {
                if (e.key === 'darkMode') {
                    this.loadSettings();
                }
            });

            window.addEventListener('darkmodechange', () => {
                this.loadSettings();
            });
        }

        broadcastChange() {
            window.dispatchEvent(new Event('darkmodechange'));
        }
    }

    // è¨­å®šé–¢æ•°
    function toggleDarkMode() {
        const checkbox = document.getElementById('darkMode');
        const isDark = checkbox ? checkbox.checked : !document.body.classList.contains('dark-mode');

        if (isDark) {
            document.body.classList.add('dark-mode');
            localStorage.setItem('darkMode', 'true');
        } else {
            document.body.classList.remove('dark-mode');
            localStorage.setItem('darkMode', 'false');
        }

        formDarkModeManager.broadcastChange();
    }

    function toggleCompactView() {
        const checkbox = document.getElementById('compactView');
        const isCompact = checkbox ? checkbox.checked : false;

        localStorage.setItem('compactView', isCompact ? 'true' : 'false');
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºæ©Ÿèƒ½
    function showModal(title, content) {
        // æ—¢å­˜ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒã‚ã‚Œã°å‰Šé™¤
        const existingModal = document.getElementById('formModalOverlay');
        if (existingModal) {
            existingModal.remove();
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«HTMLä½œæˆ
        const modalHTML = `
            <div id="formModalOverlay" class="modal-overlay" style="display: flex;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>${title}</h3>
                        <button class="modal-close" onclick="closeFormModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        ${content}
                    </div>
                    <div class="modal-footer">
                        <button class="modal-btn" onclick="closeFormModal()">é–‰ã˜ã‚‹</button>
                    </div>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHTML);
        document.body.style.overflow = 'hidden';

        // ESCã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        document.addEventListener('keydown', function escHandler(e) {
            if (e.key === 'Escape') {
                closeFormModal();
                document.removeEventListener('keydown', escHandler);
            }
        });

        // å¤–å´ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        document.getElementById('formModalOverlay').addEventListener('click', function(e) {
            if (e.target.id === 'formModalOverlay') {
                closeFormModal();
            }
        });
    }

    function closeFormModal() {
        const modal = document.getElementById('formModalOverlay');
        if (modal) {
            modal.remove();
            document.body.style.overflow = 'auto';
        }
    }

    // è¨­å®šè¡¨ç¤º
    function showSettings() {
        const settingsContent = `
            <div class="settings-content">
                <h4>âš™ï¸ è¨­å®š</h4>
                <div class="settings-section">
                    <h5>ğŸ¨ è¡¨ç¤ºè¨­å®š</h5>
                    <div class="setting-item">
                        <span>ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰</span>
                        <label class="switch">
                            <input type="checkbox" id="darkMode" onchange="toggleDarkMode()">
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <span>ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆè¡¨ç¤º</span>
                        <label class="switch">
                            <input type="checkbox" id="compactView" onchange="toggleCompactView()">
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>
                <div class="settings-section">
                    <h5>â„¹ï¸ ã‚¢ãƒ—ãƒªæƒ…å ±</h5>
                    <p><strong>ãƒãƒ¼ã‚¸ãƒ§ãƒ³:</strong> 1.0.0</p>
                    <p><strong>æœ€çµ‚æ›´æ–°:</strong> 2024å¹´</p>
                </div>
            </div>
        `;
        showModal('è¨­å®š', settingsContent);

        setTimeout(() => {
            loadSettingsInModal();
        }, 100);
    }

    function loadSettingsInModal() {
        const darkModeCheckbox = document.getElementById('darkMode');
        const compactViewCheckbox = document.getElementById('compactView');

        if (darkModeCheckbox) {
            darkModeCheckbox.checked = localStorage.getItem('darkMode') === 'true';
        }
        if (compactViewCheckbox) {
            compactViewCheckbox.checked = localStorage.getItem('compactView') === 'true';
        }
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¡¨ç¤º
    function showUserInfo() {
        const userInfo = `
            <div class="user-stats">
                <h4>ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±</h4>
                <p><strong>ç¾åœ¨ã®ãƒšãƒ¼ã‚¸:</strong> ãƒ¬ã‚·ãƒ”ãƒ•ã‚©ãƒ¼ãƒ </p>
                <p><strong>ç™»éŒ²æ—¥:</strong> 2024å¹´</p>
            </div>
        `;
        showModal('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±', userInfo);
    }

    // ãƒ˜ãƒ«ãƒ—è¡¨ç¤º
    function showHelp() {
        const helpContent = `
            <div class="help-content">
                <h4>ğŸ“– RecipeAppã®ä½¿ã„æ–¹</h4>
                <div class="help-section">
                    <h5>ğŸ†• ãƒ¬ã‚·ãƒ”ã®è¿½åŠ </h5>
                    <p>ãƒ•ã‚©ãƒ¼ãƒ ã«å¿…è¦ãªæƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãƒ¬ã‚·ãƒ”ã‚’ä½œæˆã§ãã¾ã™ã€‚</p>
                </div>
                <div class="help-section">
                    <h5>ğŸ“ å…¥åŠ›ã®ã‚³ãƒ„</h5>
                    <p>ææ–™ã¨æ‰‹é †ã¯è©³ã—ãè¨˜å…¥ã™ã‚‹ã¨ã€å¾Œã§è¦‹è¿”ã—ã‚„ã™ããªã‚Šã¾ã™ã€‚</p>
                </div>
            </div>
        `;
        showModal('ãƒ˜ãƒ«ãƒ—', helpContent);
    }

    // ã‚µã‚¤ãƒ‰ãƒãƒ¼æ©Ÿèƒ½ï¼ˆãƒ•ã‚©ãƒ¼ãƒ ç”»é¢ç”¨ï¼‰
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        if (sidebar) {
            sidebar.classList.toggle('active');
        }
    }

    // åˆæœŸåŒ–
    const formDarkModeManager = new FormDarkModeManager();

    document.addEventListener('DOMContentLoaded', function() {
        formDarkModeManager.loadSettings();
    });
</script>

<script>
    // ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œã®ã‚µã‚¤ãƒ‰ãƒãƒ¼æ©Ÿèƒ½
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.toggle('active');
    }

    function checkScreenSize() {
        const sidebar = document.getElementById('sidebar');
        if (window.innerWidth > 768) {
            sidebar.classList.remove('active');
        }
    }

    document.addEventListener('click', function (e) {
        const sidebar = document.getElementById('sidebar');
        const toggleBtn = document.querySelector('.sidebar-toggle');
        const closeBtn = document.querySelector('.sidebar-close');
        const sidebarContent = document.querySelector('.sidebar-content');

        if (window.innerWidth <= 768) {
            if (!sidebarContent.contains(e.target) &&
                !toggleBtn.contains(e.target) &&
                !closeBtn.contains(e.target)) {
                sidebar.classList.remove('active');
            }
        }
    });

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const sidebar = document.getElementById('sidebar');
            if (sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
            }
        }
    });

    window.addEventListener('resize', checkScreenSize);
    document.addEventListener('DOMContentLoaded', checkScreenSize);

    // ã‚«ãƒ†ã‚´ãƒªåˆ¶é™ã®è¨­å®š
    const MAX_CATEGORIES = 3;
    let formSubmissionBlocked = false;

    // æ–°ã—ã„ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å‡¦ç†
    function handleImagePreview(event) {
        const file = event.target.files[0];
        const previewContainer = document.getElementById('preview-container');
        const previewImage = document.getElementById('image-preview');

        if (file && file.type.startsWith('image/')) {
            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆ5MBåˆ¶é™ï¼‰
            if (file.size > 5 * 1024 * 1024) {
                alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ã€‚5MBä»¥ä¸‹ã®ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                event.target.value = '';
                previewContainer.style.display = 'none';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                previewImage.src = e.target.result;
                previewContainer.style.display = 'block';
            };
            reader.readAsDataURL(file);
        } else if (file) {
            alert('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆJPEG, PNG, GIF, WebPå¯¾å¿œï¼‰ã€‚');
            event.target.value = '';
            previewContainer.style.display = 'none';
        } else {
            previewContainer.style.display = 'none';
            previewImage.src = '';
        }
    }

    // æ–°ã—ãé¸ã‚“ã ç”»åƒã‚’å‰Šé™¤ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã‚¤ãƒ³ãƒ—ãƒƒãƒˆã‚’ãƒªã‚»ãƒƒãƒˆï¼‰
    function removeImagePreview() {
        const fileInput = document.getElementById('image');
        const previewContainer = document.getElementById('preview-container');
        const previewImage = document.getElementById('image-preview');

        const newInput = fileInput.cloneNode(true);
        newInput.value = '';
        newInput.addEventListener('change', handleImagePreview);
        fileInput.parentNode.replaceChild(newInput, fileInput);

        previewImage.src = '';
        previewContainer.style.display = 'none';
    }

    // æ—¢å­˜ã®ç”»åƒã‚’å‰Šé™¤ï¼ˆç·¨é›†æ™‚ï¼‰
    function removeCurrentImage() {
        const currentImage = document.getElementById('current-image');
        const currentWrapper = document.getElementById('current-image-wrapper');
        const deleteInput = document.getElementById('deleteCurrentImage');

        currentWrapper.style.display = 'none';
        deleteInput.value = 'true';
    }

    // ãŠæ°—ã«å…¥ã‚Šãƒˆã‚°ãƒ«æ©Ÿèƒ½
    function toggleFavorite(button) {
        const icon = document.getElementById('favorite-icon');
        const input = document.getElementById('favorite-input');
        const isSelected = icon.classList.toggle('selected');
        input.value = isSelected ? "true" : "false";
        icon.src = isSelected ? "/images/icons/heart_active.svg" : "/images/icons/heart_off.svg";
    }

    // ã‚«ãƒ†ã‚´ãƒªã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã®æ©Ÿèƒ½
    function toggleDropdown() {
        const options = document.getElementById('category-options');
        const arrow = document.querySelector('.arrow');
        const isVisible = options.style.display === 'block';

        options.style.display = isVisible ? 'none' : 'block';
        arrow.style.transform = isVisible ? 'rotate(0deg)' : 'rotate(180deg)';
    }

    // ã‚«ãƒ†ã‚´ãƒªé¸æŠçŠ¶æ³ã‚’æ›´æ–°ï¼ˆä¿®æ­£ç‰ˆï¼‰
    function updateSelectedCategories() {
        const checkboxes = document.querySelectorAll('input[name="categories"]:checked');
        const selectedText = document.getElementById('selected-categories');
        const selectedTags = document.getElementById('selected-tags');
        const limitMessage = document.getElementById('category-limit-message');
        const submitBtn = document.getElementById('submit-btn');
        const allCheckboxes = document.querySelectorAll('input[name="categories"]');

        console.log('ã‚«ãƒ†ã‚´ãƒªæ›´æ–° - é¸æŠæ•°:', checkboxes.length);
        console.log('ã‚«ãƒ†ã‚´ãƒªæ›´æ–° - é¸æŠå†…å®¹:', Array.from(checkboxes).map(cb => cb.value));

        // é¸æŠçŠ¶æ³ã®è¡¨ç¤ºæ›´æ–°
        if (checkboxes.length === 0) {
            selectedText.textContent = 'ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„';
            selectedTags.innerHTML = '';
            limitMessage.style.display = 'none';
            formSubmissionBlocked = false;
        } else {
            selectedText.textContent = `${checkboxes.length}å€‹ã®ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠä¸­`;
            selectedTags.innerHTML = '';

            // åˆ¶é™ãƒã‚§ãƒƒã‚¯ï¼ˆå³æ ¼åŒ–ï¼‰
            if (checkboxes.length > MAX_CATEGORIES) {
                console.log('ã‚«ãƒ†ã‚´ãƒªä¸Šé™ã‚¨ãƒ©ãƒ¼:', checkboxes.length, '>', MAX_CATEGORIES);
                limitMessage.style.display = 'block';
                limitMessage.textContent = `ã‚«ãƒ†ã‚´ãƒªã¯${MAX_CATEGORIES}ã¤ã¾ã§ã—ã‹é¸æŠã§ãã¾ã›ã‚“ã€‚ç¾åœ¨${checkboxes.length}ã¤é¸æŠã•ã‚Œã¦ã„ã¾ã™ã€‚`;
                limitMessage.className = 'category-limit-message error';
                formSubmissionBlocked = true;

                // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
                submitBtn.disabled = true;
                submitBtn.style.opacity = '0.6';
                submitBtn.style.cursor = 'not-allowed';
                submitBtn.title = 'ã‚«ãƒ†ã‚´ãƒªã®é¸æŠæ•°ã‚’æ¸›ã‚‰ã—ã¦ãã ã•ã„';

                // æœªé¸æŠã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ç„¡åŠ¹åŒ–
                allCheckboxes.forEach(checkbox => {
                    if (!checkbox.checked) {
                        checkbox.disabled = true;
                        checkbox.parentElement.classList.add('disabled');
                    } else {
                        checkbox.disabled = false;
                        checkbox.parentElement.classList.remove('disabled');
                    }
                });
            } else if (checkboxes.length === MAX_CATEGORIES) {
                limitMessage.style.display = 'block';
                limitMessage.textContent = `ã‚«ãƒ†ã‚´ãƒªã‚’${MAX_CATEGORIES}ã¤é¸æŠã—ã¾ã—ãŸï¼ˆä¸Šé™ï¼‰`;
                limitMessage.className = 'category-limit-message';
                formSubmissionBlocked = false;

                // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                submitBtn.disabled = false;
                submitBtn.style.opacity = '1';
                submitBtn.style.cursor = 'pointer';
                submitBtn.title = '';

                // æœªé¸æŠã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ç„¡åŠ¹åŒ–
                allCheckboxes.forEach(checkbox => {
                    if (!checkbox.checked) {
                        checkbox.disabled = true;
                        checkbox.parentElement.classList.add('disabled');
                    } else {
                        checkbox.disabled = false;
                        checkbox.parentElement.classList.remove('disabled');
                    }
                });
            } else {
                limitMessage.style.display = 'none';
                formSubmissionBlocked = false;

                // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                submitBtn.disabled = false;
                submitBtn.style.opacity = '1';
                submitBtn.style.cursor = 'pointer';
                submitBtn.title = '';

                // å…¨ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’æœ‰åŠ¹åŒ–
                allCheckboxes.forEach(checkbox => {
                    checkbox.disabled = false;
                    checkbox.parentElement.classList.remove('disabled');
                });
            }

            // é¸æŠã•ã‚ŒãŸã‚¿ã‚°ã®è¡¨ç¤º
            checkboxes.forEach(checkbox => {
                const tag = document.createElement('span');
                tag.className = `category-tag ${checkbox.value}`;
                tag.textContent = checkbox.value;

                const removeBtn = document.createElement('span');
                removeBtn.className = 'remove-tag';
                removeBtn.textContent = 'Ã—';
                removeBtn.onclick = () => {
                    checkbox.checked = false;
                    updateSelectedCategories();
                };

                tag.appendChild(removeBtn);
                selectedTags.appendChild(tag);
            });
        }
    }

    // ã‚«ãƒ†ã‚´ãƒªãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®changeå‡¦ç†
    function handleCategoryChange(event) {
        console.log('ã‚«ãƒ†ã‚´ãƒªå¤‰æ›´:', event.target.value, event.target.checked);
        updateSelectedCategories();
    }

    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‰ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆä¿®æ­£ç‰ˆï¼‰
    function validateForm(event) {
        const titleInput = document.getElementById('title');
        const checkedBoxes = document.querySelectorAll('input[name="categories"]:checked');

        // ã‚¿ã‚¤ãƒˆãƒ«ã®å¿…é ˆãƒã‚§ãƒƒã‚¯
        if (!titleInput.value.trim()) {
            event.preventDefault();
            alert('ã‚¿ã‚¤ãƒˆãƒ«ã¯å¿…é ˆã§ã™ã€‚');
            titleInput.focus();
            return false;
        }

        // ã‚«ãƒ†ã‚´ãƒªæ•°ãƒã‚§ãƒƒã‚¯
        if (checkedBoxes.length > MAX_CATEGORIES) {
            event.preventDefault();
            console.log('ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡é˜»æ­¢ - ã‚«ãƒ†ã‚´ãƒªæ•°:', checkedBoxes.length);
            alert(`ã‚«ãƒ†ã‚´ãƒªãŒ${checkedBoxes.length}ã¤é¸æŠã•ã‚Œã¦ã„ã‚‹ãŸã‚ç™»éŒ²ã§ãã¾ã›ã‚“ã€‚ã‚«ãƒ†ã‚´ãƒªã¯${MAX_CATEGORIES}ã¤ã¾ã§ã—ã‹é¸æŠã§ãã¾ã›ã‚“ã€‚`);
            return false;
        }

        // é€ä¿¡ãƒ–ãƒ­ãƒƒã‚¯ãƒ•ãƒ©ã‚°ãƒã‚§ãƒƒã‚¯
        if (formSubmissionBlocked) {
            event.preventDefault();
            alert('ã‚«ãƒ†ã‚´ãƒªã®é¸æŠæ•°ãŒä¸Šé™ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚é¸æŠã‚’æ¸›ã‚‰ã—ã¦ãã ã•ã„ã€‚');
            return false;
        }

        // é€ä¿¡å‰ã«æœ€çµ‚ç¢ºèª
        console.log('ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡è¨±å¯ - ã‚«ãƒ†ã‚´ãƒªæ•°:', checkedBoxes.length);
        return true;
    }

    // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã®åˆæœŸåŒ–
    document.addEventListener("DOMContentLoaded", () => {
        // ãŠæ°—ã«å…¥ã‚Šã‚¢ã‚¤ã‚³ãƒ³ã®åˆæœŸåŒ–
        const icon = document.getElementById("favorite-icon");
        const input = document.getElementById("favorite-input");
        if (icon && input) {
            icon.src = input.value === "true"
                ? "/images/icons/heart_active.svg"
                : "/images/icons/heart_off.svg";
            if (input.value === "true") {
                icon.classList.add("selected");
            }
        }

        // ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ã®åˆæœŸåŒ–
        const imageInput = document.getElementById('image');
        if (imageInput) {
            imageInput.addEventListener('change', handleImagePreview);
        }

        // ã‚«ãƒ†ã‚´ãƒªãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        const categoryCheckboxes = document.querySelectorAll('input[name="categories"]');
        categoryCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', handleCategoryChange);
        });

        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        const form = document.getElementById('recipe-form');
        if (form) {
            form.addEventListener('submit', validateForm);
        }

        // åˆæœŸçŠ¶æ…‹ã®è¡¨ç¤ºæ›´æ–°
        updateSelectedCategories();

        // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        document.addEventListener('click', (e) => {
            const categorySelector = document.querySelector('.category-selector');
            const options = document.getElementById('category-options');
            const arrow = document.querySelector('.arrow');

            if (!categorySelector.contains(e.target)) {
                options.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        });

        // Enter ã‚­ãƒ¼ã§ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’ãƒˆã‚°ãƒ«
        const selectTrigger = document.querySelector('.select-trigger');
        if (selectTrigger) {
            selectTrigger.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    toggleDropdown();
                }
            });
        }

        // ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è‡ªå‹•éè¡¨ç¤º
        const flashMessages = document.querySelectorAll('.flash-message');
        flashMessages.forEach(message => {
            setTimeout(() => {
                message.style.opacity = '0';
                message.style.transform = 'translateY(-10px)';
                setTimeout(() => {
                    if (message.parentNode) {
                        message.parentNode.removeChild(message);
                    }
                }, 300);
            }, 5000); // 5ç§’å¾Œã«éè¡¨ç¤º
        });

        console.log('ãƒ•ã‚©ãƒ¼ãƒ åˆæœŸåŒ–å®Œäº†');
    });
</script>

</body>
</html>