<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title th:text="${recipe.id} != null ? '„É¨„Ç∑„ÉîÁ∑®ÈõÜ' : '„É¨„Ç∑„ÉîËøΩÂä†'">„É¨„Ç∑„ÉîËøΩÂä†</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="/assets/css/sanitize.css">
    <link rel="stylesheet" href="/assets/css/style.css">
</head>
<body class="page-add">
<div class="container">
    <header class="top-navbar">
        <button class="sidebar-toggle" onclick="toggleSidebar()" aria-label="„É°„Éã„É•„Éº„ÇíÈñã„Åè">
            <span></span>
        </button>
        <div class="title">Recipin'</div>
        <div class="header-right">
            <!-- „Éò„ÉÉ„ÉÄ„ÉºÂè≥ÂÅ¥ -->
            <div class="user-info" sec:authorize="isAuthenticated()">
                <span th:text="'„Çà„ÅÜ„Åì„Åù„ÄÅ' + ${#authentication.name} + '„Åï„Çì'">„É¶„Éº„Ç∂„ÉºÂêç</span>
            </div>
            <div class="header-actions" sec:authorize="isAuthenticated()">
                <form th:action="@{/logout}" method="post" style="display:inline;">
                    <button type="submit" class="logout-btn">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
                </form>
            </div>
        </div>
    </header>

    <!-- Sidebar -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-content">
            <div class="sidebar-header">
                <button class="sidebar-close" onclick="toggleSidebar()" aria-label="„É°„Éã„É•„Éº„ÇíÈñâ„Åò„Çã">
                    ‚úï
                </button>
            </div>
            <ul>
                <li>
                    <a href="/home" class="home-button">
                        <img src="/images/icons/home.svg" alt="„Éõ„Éº„É†" />
                        <span>„Éõ„Éº„É†</span>
                    </a>
                </li>
                <li>
                    <a href="/home">
                        <img src="/images/icons/book.svg" alt="„É¨„Ç∑„Éî‰∏ÄË¶ß" />
                        <span>„É¨„Ç∑„Éî‰∏ÄË¶ß</span>
                    </a>
                </li>
                <li>
                    <a href="/recipes/favorites">
                        <img src="/images/icons/heart.svg" alt="„ÅäÊ∞ó„Å´ÂÖ•„Çä">
                        <span>„ÅäÊ∞ó„Å´ÂÖ•„Çä</span>
                    </a>
                </li>
                <li>
                    <a href="/home">
                        <img src="/images/icons/category.svg" alt="„Ç´„ÉÜ„Ç¥„É™‰∏ÄË¶ß" />
                        <span>„Ç´„ÉÜ„Ç¥„É™‰∏ÄË¶ß</span>
                    </a>
                </li>
                <li>
                    <div class="menu-item" onclick="showUserInfo()">
                        <img src="/images/icons/user.svg" alt="„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±" />
                        <span>„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±</span>
                    </div>
                </li>
                <li>
                    <div class="menu-item" onclick="showHelp()">
                        <img src="/images/icons/interrogation.svg" alt="„Éò„É´„Éó" />
                        <span>„Éò„É´„Éó</span>
                    </div>
                </li>
                <li class="bottom">
                    <div class="menu-item" onclick="showSettings()">
                        <img src="/images/icons/settings.svg" alt="Ë®≠ÂÆö" />
                        <span>Ë®≠ÂÆö</span>
                    </div>
                </li>
                <li class="bottom" sec:authorize="isAuthenticated()">
                    <form th:action="@{/logout}" method="post" style="margin:0;">
                        <button type="submit" class="logout-sidebar-btn">
                            <img src="/images/icons/logout.svg" alt="„É≠„Ç∞„Ç¢„Ç¶„Éà" />
                            <span>„É≠„Ç∞„Ç¢„Ç¶„Éà</span>
                        </button>
                    </form>
                </li>
            </ul>
        </div>
    </nav>

    <main class="main-content">
        <div class="section-header">
            <div class="section-title">
                <h1 th:text="${recipe.id} != null ? '„É¨„Ç∑„Éî„ÇíÁ∑®ÈõÜ' : '„É¨„Ç∑„Éî„ÇíËøΩÂä†'">„É¨„Ç∑„Éî„ÇíËøΩÂä†</h1>
            </div>
            <div class="add-button-container">
                <a href="/home" class="add-button back-button">
                    <span class="add-text">Êàª„Çã</span>
                    <img src="/images/icons/back.svg" alt="Êàª„Çã">
                </a>
            </div>
        </div>

        <div class="form-container">
            <!-- „ÅäÊ∞ó„Å´ÂÖ•„Çä„Éú„Çø„É≥„ÇíÂè≥‰∏ä„Å´ÈÖçÁΩÆÔºà‰øÆÊ≠£ÁâàÔºâ -->
            <button type="button" class="favorite-toggle favorite-top-right" onclick="toggleFavorite(this)" aria-label="„ÅäÊ∞ó„Å´ÂÖ•„Çä„Å´ËøΩÂä†">
                <img id="favorite-icon"
                     th:src="${recipe.favorite} ? '/images/icons/heart_active.svg' : '/images/icons/heart_off.svg'"
                     th:classappend="${recipe.favorite} ? ' selected' : ''"
                     alt="„ÅäÊ∞ó„Å´ÂÖ•„Çä"
                     class="heart-image">
            </button>

            <!-- „Éï„É©„ÉÉ„Ç∑„É•„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫ -->
            <div th:if="${successMessage}" class="flash-message success-message">
                <span th:text="${successMessage}"></span>
            </div>
            <div th:if="${warningMessage}" class="flash-message warning-message">
                <span th:text="${warningMessage}"></span>
            </div>
            <div th:if="${errorMessage}" class="flash-message error-message">
                <span th:text="${errorMessage}"></span>
            </div>

            <form th:action="@{${recipe.id} != null ? '/recipes/update' : '/recipes/new'}" th:object="${recipe}" method="post" enctype="multipart/form-data" id="recipe-form">
                <!-- IDÔºàÁ∑®ÈõÜÊôÇ„ÅÆ„ÅøÔºâ -->
                <input type="hidden" th:if="${recipe.id}" th:name="id" th:value="${recipe.id}" />

                <!-- „ÅäÊ∞ó„Å´ÂÖ•„Çä„ÅÆÂÄ§„Çí‰øùÊåÅ„Åô„ÇãÈö†„Åó„Éï„Ç£„Éº„É´„Éâ -->
                <input type="hidden" th:name="favorite" th:value="${recipe.favorite}" id="favorite-input" />

                <div class="form-group">
                    <label for="title">„Çø„Ç§„Éà„É´ <span style="color: red;">*</span></label>
                    <input type="text" id="title" th:name="title" th:value="${recipe.title}" required maxlength="100">
                </div>

                <div class="form-group">
                    <label for="image">„É¨„Ç∑„ÉîÁîªÂÉè</label>
                    <div class="file-input-wrapper">
                        <input type="file" id="image" name="image" accept="image/jpeg,image/jpg,image/png,image/gif,image/webp" />
                        üì∑ ÁîªÂÉè„ÇíÈÅ∏Êäû
                    </div>

                    <!-- Á∑®ÈõÜÊôÇ„ÅÆÊó¢Â≠òÁîªÂÉèË°®Á§∫„Å®ÂâäÈô§ -->
                    <div th:if="${recipe.imagePath}" class="image-preview-container" id="current-image-wrapper">
                        <span class="current-image-label">ÁèæÂú®„ÅÆÁîªÂÉè:</span>
                        <img th:src="@{${recipe.imagePath}}" alt="ÁèæÂú®„ÅÆÁîªÂÉè" class="image-preview" id="current-image" />
                        <button type="button" class="image-remove" onclick="removeCurrentImage()">√ó</button>
                        <input type="hidden" name="deleteCurrentImage" id="deleteCurrentImage" value="false" />
                    </div>

                    <!-- Êñ∞„Åó„ÅÑÁîªÂÉè„ÅÆ„Éó„É¨„Éì„É•„Éº -->
                    <div class="image-preview-container" id="preview-container" style="display: none;">
                        <span class="current-image-label">ÈÅ∏Êäû„Åó„ÅüÁîªÂÉè:</span>
                        <img id="image-preview" class="image-preview" alt="ÁîªÂÉè„Éó„É¨„Éì„É•„Éº" />
                        <button type="button" class="image-remove" onclick="removeImagePreview()">√ó</button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="ingredients">ÊùêÊñô</label>
                    <textarea id="ingredients" th:name="ingredients" th:text="${recipe.ingredients}" placeholder="‰æãÔºö&#10;„ÉªÁéâ„Å≠„Åé 1ÂÄã&#10;„Éª„Å´„Çì„Åò„Çì 1Êú¨&#10;„Éª„Åò„ÇÉ„Åå„ÅÑ„ÇÇ 2ÂÄã"></textarea>
                </div>

                <div class="form-group">
                    <label for="instructions">‰Ωú„ÇäÊñπ</label>
                    <textarea id="instructions" th:name="instructions" th:text="${recipe.instructions}" placeholder="‰æãÔºö&#10;1. Áéâ„Å≠„Åé„ÇíËñÑÂàá„Çä„Å´„Åô„Çã&#10;2. „Éï„É©„Ç§„Éë„É≥„ÅßÁÇí„ÇÅ„Çã&#10;3. Â°©ËÉ°Ê§í„ÅßÂë≥‰ªò„Åë„Åô„Çã"></textarea>
                </div>

                <div class="form-group">
                    <label for="reference">ÂèÇËÄÉÂãïÁîª„Éª„Çµ„Ç§„ÉàÔºàURLÔºâ</label>
                    <input type="url" id="reference" th:name="reference" th:value="${recipe.reference}" placeholder="https://example.com">
                </div>

                <div class="form-group">
                    <label for="category-select">„Ç´„ÉÜ„Ç¥„É™ÔºàÊúÄÂ§ß3„Å§„Åæ„ÅßÈÅ∏ÊäûÂèØÔºâ</label>
                    <div class="category-selector">
                        <div class="custom-select">
                            <div class="select-trigger" onclick="toggleDropdown()" tabindex="0">
                                <span id="selected-categories">„Ç´„ÉÜ„Ç¥„É™„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</span>
                                <span class="arrow">‚ñº</span>
                            </div>
                            <div class="select-options" id="category-options">
                                <label class="option"><input type="checkbox" name="categories" value="ÂíåÈ£ü" th:checked="${recipe.categories != null and recipe.categories.contains('ÂíåÈ£ü')}"> ÂíåÈ£ü</label>
                                <label class="option"><input type="checkbox" name="categories" value="Ê¥ãÈ£ü" th:checked="${recipe.categories != null and recipe.categories.contains('Ê¥ãÈ£ü')}"> Ê¥ãÈ£ü</label>
                                <label class="option"><input type="checkbox" name="categories" value="‰∏≠ËèØ" th:checked="${recipe.categories != null and recipe.categories.contains('‰∏≠ËèØ')}"> ‰∏≠ËèØ</label>
                                <label class="option"><input type="checkbox" name="categories" value="È∫∫È°û" th:checked="${recipe.categories != null and recipe.categories.contains('È∫∫È°û')}"> È∫∫È°û</label>
                                <label class="option"><input type="checkbox" name="categories" value="„Çπ„Éº„Éó" th:checked="${recipe.categories != null and recipe.categories.contains('„Çπ„Éº„Éó')}"> „Çπ„Éº„Éó</label>
                                <label class="option"><input type="checkbox" name="categories" value="„Çµ„É©„ÉÄ" th:checked="${recipe.categories != null and recipe.categories.contains('„Çµ„É©„ÉÄ')}"> „Çµ„É©„ÉÄ</label>
                                <label class="option"><input type="checkbox" name="categories" value="„Åä„Å§„Åæ„Åø" th:checked="${recipe.categories != null and recipe.categories.contains('„Åä„Å§„Åæ„Åø')}"> „Åä„Å§„Åæ„Åø</label>
                                <label class="option"><input type="checkbox" name="categories" value="„Éá„Ç∂„Éº„Éà" th:checked="${recipe.categories != null and recipe.categories.contains('„Éá„Ç∂„Éº„Éà')}"> „Éá„Ç∂„Éº„Éà</label>
                                <label class="option"><input type="checkbox" name="categories" value="ÊôÇÁü≠" th:checked="${recipe.categories != null and recipe.categories.contains('ÊôÇÁü≠')}"> ÊôÇÁü≠</label>
                                <label class="option"><input type="checkbox" name="categories" value="„Éò„É´„Ç∑„Éº" th:checked="${recipe.categories != null and recipe.categories.contains('„Éò„É´„Ç∑„Éº')}"> „Éò„É´„Ç∑„Éº</label>
                                <label class="option"><input type="checkbox" name="categories" value="„Åù„ÅÆ‰ªñ" th:checked="${recipe.categories != null and recipe.categories.contains('„Åù„ÅÆ‰ªñ')}"> „Åù„ÅÆ‰ªñ</label>
                            </div>
                        </div>
                        <!-- „Ç´„ÉÜ„Ç¥„É™Âà∂Èôê„É°„ÉÉ„Çª„Éº„Ç∏ -->
                        <div id="category-limit-message" class="category-limit-message" style="display: none;">
                            „Ç´„ÉÜ„Ç¥„É™„ÅÆÈÅ∏Êäû„ÅØ3„Å§„Åæ„Åß„Åß„Åô„ÄÇ
                        </div>
                        <div class="selected-tags" id="selected-tags"></div>
                    </div>
                </div>

                <div class="button-wrapper">
                    <button type="submit" class="submit-button" th:text="${recipe.id} != null ? 'Êõ¥Êñ∞' : 'ÁôªÈå≤'" id="submit-btn">ÁôªÈå≤</button>
                </div>
            </form>
        </div>
    </main>
</div>

<script>
    // „Éï„Ç©„Éº„É†ÁîªÈù¢Áî®„ÉÄ„Éº„ÇØ„É¢„Éº„ÉâÂØæÂøú
    class FormDarkModeManager {
        constructor() {
            this.init();
        }

        init() {
            // ÂàùÊúüË®≠ÂÆö„ÅÆË™≠„ÅøËæº„Åø
            this.loadSettings();
            // Ë®≠ÂÆöÂ§âÊõ¥„ÅÆÁõ£Ë¶ñ
            this.watchStorageChanges();
        }

        loadSettings() {
            const darkMode = localStorage.getItem('darkMode') === 'true';
            const compactView = localStorage.getItem('compactView') === 'true';

            if (darkMode) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
        }

        watchStorageChanges() {
            // localStorage „ÅÆÂ§âÊõ¥„ÇíÁõ£Ë¶ñ
            window.addEventListener('storage', (e) => {
                if (e.key === 'darkMode') {
                    this.loadSettings();
                }
            });

            window.addEventListener('darkmodechange', () => {
                this.loadSettings();
            });
        }

        broadcastChange() {
            window.dispatchEvent(new Event('darkmodechange'));
        }
    }

    // Ë®≠ÂÆöÈñ¢Êï∞
    function toggleDarkMode() {
        const checkbox = document.getElementById('darkMode');
        const isDark = checkbox ? checkbox.checked : !document.body.classList.contains('dark-mode');

        if (isDark) {
            document.body.classList.add('dark-mode');
            localStorage.setItem('darkMode', 'true');
        } else {
            document.body.classList.remove('dark-mode');
            localStorage.setItem('darkMode', 'false');
        }

        formDarkModeManager.broadcastChange();
    }

    function toggleCompactView() {
        const checkbox = document.getElementById('compactView');
        const isCompact = checkbox ? checkbox.checked : false;

        localStorage.setItem('compactView', isCompact ? 'true' : 'false');
    }

    // „É¢„Éº„ÉÄ„É´Ë°®Á§∫Ê©üËÉΩ
    function showModal(title, content) {
        // Êó¢Â≠ò„ÅÆ„É¢„Éº„ÉÄ„É´„Åå„ÅÇ„Çå„Å∞ÂâäÈô§
        const existingModal = document.getElementById('formModalOverlay');
        if (existingModal) {
            existingModal.remove();
        }

        // „É¢„Éº„ÉÄ„É´HTML‰ΩúÊàê
        const modalHTML = `
            <div id="formModalOverlay" class="modal-overlay" style="display: flex;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>${title}</h3>
                        <button class="modal-close" onclick="closeFormModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        ${content}
                    </div>
                    <div class="modal-footer">
                        <button class="modal-btn" onclick="closeFormModal()">Èñâ„Åò„Çã</button>
                    </div>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHTML);
        document.body.style.overflow = 'hidden';

        // ESC„Ç≠„Éº„Åß„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        document.addEventListener('keydown', function escHandler(e) {
            if (e.key === 'Escape') {
                closeFormModal();
                document.removeEventListener('keydown', escHandler);
            }
        });

        // Â§ñÂÅ¥„ÇØ„É™„ÉÉ„ÇØ„Åß„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        document.getElementById('formModalOverlay').addEventListener('click', function(e) {
            if (e.target.id === 'formModalOverlay') {
                closeFormModal();
            }
        });
    }

    function closeFormModal() {
        const modal = document.getElementById('formModalOverlay');
        if (modal) {
            modal.remove();
            document.body.style.overflow = 'auto';
        }
    }

    // Ë®≠ÂÆöË°®Á§∫
    function showSettings() {
        const settingsContent = `
            <div class="settings-content">
                <h4>‚öôÔ∏è Ë®≠ÂÆö</h4>
                <div class="settings-section">
                    <h5>üé® Ë°®Á§∫Ë®≠ÂÆö</h5>
                    <div class="setting-item">
                        <span>„ÉÄ„Éº„ÇØ„É¢„Éº„Éâ</span>
                        <label class="switch">
                            <input type="checkbox" id="darkMode" onchange="toggleDarkMode()">
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <span>„Ç≥„É≥„Éë„ÇØ„ÉàË°®Á§∫</span>
                        <label class="switch">
                            <input type="checkbox" id="compactView" onchange="toggleCompactView()">
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>
                <div class="settings-section">
                    <h5>‚ÑπÔ∏è „Ç¢„Éó„É™ÊÉÖÂ†±</h5>
                    <p><strong>„Éê„Éº„Ç∏„Éß„É≥:</strong> 1.0.0</p>
                    <p><strong>ÊúÄÁµÇÊõ¥Êñ∞:</strong> 2024Âπ¥</p>
                </div>
            </div>
        `;
        showModal('Ë®≠ÂÆö', settingsContent);

        setTimeout(() => {
            loadSettingsInModal();
        }, 100);
    }

    function loadSettingsInModal() {
        const darkModeCheckbox = document.getElementById('darkMode');
        const compactViewCheckbox = document.getElementById('compactView');

        if (darkModeCheckbox) {
            darkModeCheckbox.checked = localStorage.getItem('darkMode') === 'true';
        }
        if (compactViewCheckbox) {
            compactViewCheckbox.checked = localStorage.getItem('compactView') === 'true';
        }
    }

    // „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±Ë°®Á§∫
    function showUserInfo() {
        const userInfo = `
            <div class="user-stats">
                <h4>üë§ „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±</h4>
                <p><strong>ÁèæÂú®„ÅÆ„Éö„Éº„Ç∏:</strong> „É¨„Ç∑„Éî„Éï„Ç©„Éº„É†</p>
                <p><strong>ÁôªÈå≤Êó•:</strong> 2024Âπ¥</p>
            </div>
        `;
        showModal('„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±', userInfo);
    }

    // „Éò„É´„ÉóË°®Á§∫
    function showHelp() {
        const helpContent = `
            <div class="help-content">
                <h4>üìñ RecipeApp„ÅÆ‰Ωø„ÅÑÊñπ</h4>
                <div class="help-section">
                    <h5>üÜï „É¨„Ç∑„Éî„ÅÆËøΩÂä†</h5>
                    <p>„Éï„Ç©„Éº„É†„Å´ÂøÖË¶Å„Å™ÊÉÖÂ†±„ÇíÂÖ•Âäõ„Åó„Å¶„É¨„Ç∑„Éî„Çí‰ΩúÊàê„Åß„Åç„Åæ„Åô„ÄÇ</p>
                </div>
                <div class="help-section">
                    <h5>üìù ÂÖ•Âäõ„ÅÆ„Ç≥„ÉÑ</h5>
                    <p>ÊùêÊñô„Å®ÊâãÈ†Ü„ÅØË©≥„Åó„ÅèË®òÂÖ•„Åô„Çã„Å®„ÄÅÂæå„ÅßË¶ãËøî„Åó„ÇÑ„Åô„Åè„Å™„Çä„Åæ„Åô„ÄÇ</p>
                </div>
            </div>
        `;
        showModal('„Éò„É´„Éó', helpContent);
    }

    // „Çµ„Ç§„Éâ„Éê„ÉºÊ©üËÉΩÔºà„Éï„Ç©„Éº„É†ÁîªÈù¢Áî®Ôºâ
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        if (sidebar) {
            sidebar.classList.toggle('active');
        }
    }

    // ÂàùÊúüÂåñ
    const formDarkModeManager = new FormDarkModeManager();

    document.addEventListener('DOMContentLoaded', function() {
        formDarkModeManager.loadSettings();
    });
</script>

<script>
    // „É¢„Éê„Ç§„É´ÂØæÂøú„ÅÆ„Çµ„Ç§„Éâ„Éê„ÉºÊ©üËÉΩ
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.toggle('active');
    }

    function checkScreenSize() {
        const sidebar = document.getElementById('sidebar');
        if (window.innerWidth > 768) {
            sidebar.classList.remove('active');
        }
    }

    document.addEventListener('click', function (e) {
        const sidebar = document.getElementById('sidebar');
        const toggleBtn = document.querySelector('.sidebar-toggle');
        const closeBtn = document.querySelector('.sidebar-close');
        const sidebarContent = document.querySelector('.sidebar-content');

        if (window.innerWidth <= 768) {
            if (!sidebarContent.contains(e.target) &&
                !toggleBtn.contains(e.target) &&
                !closeBtn.contains(e.target)) {
                sidebar.classList.remove('active');
            }
        }
    });

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const sidebar = document.getElementById('sidebar');
            if (sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
            }
        }
    });

    window.addEventListener('resize', checkScreenSize);
    document.addEventListener('DOMContentLoaded', checkScreenSize);

    // „Ç´„ÉÜ„Ç¥„É™Âà∂Èôê„ÅÆË®≠ÂÆö
    const MAX_CATEGORIES = 3;
    let formSubmissionBlocked = false;

    // Êñ∞„Åó„ÅÑÁîªÂÉè„Éó„É¨„Éì„É•„ÉºÂá¶ÁêÜ
    function handleImagePreview(event) {
        const file = event.target.files[0];
        const previewContainer = document.getElementById('preview-container');
        const previewImage = document.getElementById('image-preview');

        if (file && file.type.startsWith('image/')) {
            // „Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„ÉÅ„Çß„ÉÉ„ÇØÔºà5MBÂà∂ÈôêÔºâ
            if (file.size > 5 * 1024 * 1024) {
                alert('„Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„ÅåÂ§ß„Åç„Åô„Åé„Åæ„Åô„ÄÇ5MB‰ª•‰∏ã„ÅÆÁîªÂÉè„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                event.target.value = '';
                previewContainer.style.display = 'none';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                previewImage.src = e.target.result;
                previewContainer.style.display = 'block';
            };
            reader.readAsDataURL(file);
        } else if (file) {
            alert('ÁîªÂÉè„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàJPEG, PNG, GIF, WebPÂØæÂøúÔºâ„ÄÇ');
            event.target.value = '';
            previewContainer.style.display = 'none';
        } else {
            previewContainer.style.display = 'none';
            previewImage.src = '';
        }
    }

    // Êñ∞„Åó„ÅèÈÅ∏„Çì„Å†ÁîªÂÉè„ÇíÂâäÈô§Ôºà„Éï„Ç°„Ç§„É´„Ç§„É≥„Éó„ÉÉ„Éà„Çí„É™„Çª„ÉÉ„ÉàÔºâ
    function removeImagePreview() {
        const fileInput = document.getElementById('image');
        const previewContainer = document.getElementById('preview-container');
        const previewImage = document.getElementById('image-preview');

        const newInput = fileInput.cloneNode(true);
        newInput.value = '';
        newInput.addEventListener('change', handleImagePreview);
        fileInput.parentNode.replaceChild(newInput, fileInput);

        previewImage.src = '';
        previewContainer.style.display = 'none';
    }

    // Êó¢Â≠ò„ÅÆÁîªÂÉè„ÇíÂâäÈô§ÔºàÁ∑®ÈõÜÊôÇÔºâ
    function removeCurrentImage() {
        const currentImage = document.getElementById('current-image');
        const currentWrapper = document.getElementById('current-image-wrapper');
        const deleteInput = document.getElementById('deleteCurrentImage');

        currentWrapper.style.display = 'none';
        deleteInput.value = 'true';
    }

    // „ÅäÊ∞ó„Å´ÂÖ•„Çä„Éà„Ç∞„É´Ê©üËÉΩ
    function toggleFavorite(button) {
        const icon = document.getElementById('favorite-icon');
        const input = document.getElementById('favorite-input');
        const isSelected = icon.classList.toggle('selected');
        input.value = isSelected ? "true" : "false";
        icon.src = isSelected ? "/images/icons/heart_active.svg" : "/images/icons/heart_off.svg";
    }

    // „Ç´„ÉÜ„Ç¥„É™„Çª„É¨„ÇØ„Çø„Éº„ÅÆÊ©üËÉΩ
    function toggleDropdown() {
        const options = document.getElementById('category-options');
        const arrow = document.querySelector('.arrow');
        const isVisible = options.style.display === 'block';

        options.style.display = isVisible ? 'none' : 'block';
        arrow.style.transform = isVisible ? 'rotate(0deg)' : 'rotate(180deg)';
    }

    // „Ç´„ÉÜ„Ç¥„É™ÈÅ∏ÊäûÁä∂Ê≥Å„ÇíÊõ¥Êñ∞Ôºà‰øÆÊ≠£ÁâàÔºâ
    function updateSelectedCategories() {
        const checkboxes = document.querySelectorAll('input[name="categories"]:checked');
        const selectedText = document.getElementById('selected-categories');
        const selectedTags = document.getElementById('selected-tags');
        const limitMessage = document.getElementById('category-limit-message');
        const submitBtn = document.getElementById('submit-btn');
        const allCheckboxes = document.querySelectorAll('input[name="categories"]');

        console.log('„Ç´„ÉÜ„Ç¥„É™Êõ¥Êñ∞ - ÈÅ∏ÊäûÊï∞:', checkboxes.length);
        console.log('„Ç´„ÉÜ„Ç¥„É™Êõ¥Êñ∞ - ÈÅ∏ÊäûÂÜÖÂÆπ:', Array.from(checkboxes).map(cb => cb.value));

        // ÈÅ∏ÊäûÁä∂Ê≥Å„ÅÆË°®Á§∫Êõ¥Êñ∞
        if (checkboxes.length === 0) {
            selectedText.textContent = '„Ç´„ÉÜ„Ç¥„É™„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
            selectedTags.innerHTML = '';
            limitMessage.style.display = 'none';
            formSubmissionBlocked = false;
        } else {
            selectedText.textContent = `${checkboxes.length}ÂÄã„ÅÆ„Ç´„ÉÜ„Ç¥„É™„ÇíÈÅ∏Êäû‰∏≠`;
            selectedTags.innerHTML = '';

            // Âà∂Èôê„ÉÅ„Çß„ÉÉ„ÇØÔºàÂé≥Ê†ºÂåñÔºâ
            if (checkboxes.length > MAX_CATEGORIES) {
                console.log('„Ç´„ÉÜ„Ç¥„É™‰∏äÈôê„Ç®„É©„Éº:', checkboxes.length, '>', MAX_CATEGORIES);
                limitMessage.style.display = 'block';
                limitMessage.textContent = `„Ç´„ÉÜ„Ç¥„É™„ÅØ${MAX_CATEGORIES}„Å§„Åæ„Åß„Åó„ÅãÈÅ∏Êäû„Åß„Åç„Åæ„Åõ„Çì„ÄÇÁèæÂú®${checkboxes.length}„Å§ÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ`;
                limitMessage.className = 'category-limit-message error';
                formSubmissionBlocked = true;

                // ÈÄÅ‰ø°„Éú„Çø„É≥„ÇíÁÑ°ÂäπÂåñ
                submitBtn.disabled = true;
                submitBtn.style.opacity = '0.6';
                submitBtn.style.cursor = 'not-allowed';
                submitBtn.title = '„Ç´„ÉÜ„Ç¥„É™„ÅÆÈÅ∏ÊäûÊï∞„ÇíÊ∏õ„Çâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ';

                // Êú™ÈÅ∏Êäû„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÇíÁÑ°ÂäπÂåñ
                allCheckboxes.forEach(checkbox => {
                    if (!checkbox.checked) {
                        checkbox.disabled = true;
                        checkbox.parentElement.classList.add('disabled');
                    } else {
                        checkbox.disabled = false;
                        checkbox.parentElement.classList.remove('disabled');
                    }
                });
            } else if (checkboxes.length === MAX_CATEGORIES) {
                limitMessage.style.display = 'block';
                limitMessage.textContent = `„Ç´„ÉÜ„Ç¥„É™„Çí${MAX_CATEGORIES}„Å§ÈÅ∏Êäû„Åó„Åæ„Åó„ÅüÔºà‰∏äÈôêÔºâ`;
                limitMessage.className = 'category-limit-message';
                formSubmissionBlocked = false;

                // ÈÄÅ‰ø°„Éú„Çø„É≥„ÇíÊúâÂäπÂåñ
                submitBtn.disabled = false;
                submitBtn.style.opacity = '1';
                submitBtn.style.cursor = 'pointer';
                submitBtn.title = '';

                // Êú™ÈÅ∏Êäû„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÇíÁÑ°ÂäπÂåñ
                allCheckboxes.forEach(checkbox => {
                    if (!checkbox.checked) {
                        checkbox.disabled = true;
                        checkbox.parentElement.classList.add('disabled');
                    } else {
                        checkbox.disabled = false;
                        checkbox.parentElement.classList.remove('disabled');
                    }
                });
            } else {
                limitMessage.style.display = 'none';
                formSubmissionBlocked = false;

                // ÈÄÅ‰ø°„Éú„Çø„É≥„ÇíÊúâÂäπÂåñ
                submitBtn.disabled = false;
                submitBtn.style.opacity = '1';
                submitBtn.style.cursor = 'pointer';
                submitBtn.title = '';

                // ÂÖ®„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÇíÊúâÂäπÂåñ
                allCheckboxes.forEach(checkbox => {
                    checkbox.disabled = false;
                    checkbox.parentElement.classList.remove('disabled');
                });
            }

            // ÈÅ∏Êäû„Åï„Çå„Åü„Çø„Ç∞„ÅÆË°®Á§∫
            checkboxes.forEach(checkbox => {
                const tag = document.createElement('span');
                tag.className = `category-tag ${checkbox.value}`;
                tag.textContent = checkbox.value;

                const removeBtn = document.createElement('span');
                removeBtn.className = 'remove-tag';
                removeBtn.textContent = '√ó';
                removeBtn.onclick = () => {
                    checkbox.checked = false;
                    updateSelectedCategories();
                };

                tag.appendChild(removeBtn);
                selectedTags.appendChild(tag);
            });
        }
    }

    // „Ç´„ÉÜ„Ç¥„É™„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅÆchangeÂá¶ÁêÜ
    function handleCategoryChange(event) {
        console.log('„Ç´„ÉÜ„Ç¥„É™Â§âÊõ¥:', event.target.value, event.target.checked);
        updateSelectedCategories();
    }

    // „Éï„Ç©„Éº„É†ÈÄÅ‰ø°Ââç„ÅÆ„Éê„É™„Éá„Éº„Ç∑„Éß„É≥Ôºà‰øÆÊ≠£ÁâàÔºâ
    function validateForm(event) {
        const titleInput = document.getElementById('title');
        const checkedBoxes = document.querySelectorAll('input[name="categories"]:checked');

        // „Çø„Ç§„Éà„É´„ÅÆÂøÖÈ†à„ÉÅ„Çß„ÉÉ„ÇØ
        if (!titleInput.value.trim()) {
            event.preventDefault();
            alert('„Çø„Ç§„Éà„É´„ÅØÂøÖÈ†à„Åß„Åô„ÄÇ');
            titleInput.focus();
            return false;
        }

        // „Ç´„ÉÜ„Ç¥„É™Êï∞„ÉÅ„Çß„ÉÉ„ÇØ
        if (checkedBoxes.length > MAX_CATEGORIES) {
            event.preventDefault();
            console.log('„Éï„Ç©„Éº„É†ÈÄÅ‰ø°ÈòªÊ≠¢ - „Ç´„ÉÜ„Ç¥„É™Êï∞:', checkedBoxes.length);
            alert(`„Ç´„ÉÜ„Ç¥„É™„Åå${checkedBoxes.length}„Å§ÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Çã„Åü„ÇÅÁôªÈå≤„Åß„Åç„Åæ„Åõ„Çì„ÄÇ„Ç´„ÉÜ„Ç¥„É™„ÅØ${MAX_CATEGORIES}„Å§„Åæ„Åß„Åó„ÅãÈÅ∏Êäû„Åß„Åç„Åæ„Åõ„Çì„ÄÇ`);
            return false;
        }

        // ÈÄÅ‰ø°„Éñ„É≠„ÉÉ„ÇØ„Éï„É©„Ç∞„ÉÅ„Çß„ÉÉ„ÇØ
        if (formSubmissionBlocked) {
            event.preventDefault();
            alert('„Ç´„ÉÜ„Ç¥„É™„ÅÆÈÅ∏ÊäûÊï∞„Åå‰∏äÈôê„ÇíË∂Ö„Åà„Å¶„ÅÑ„Åæ„Åô„ÄÇÈÅ∏Êäû„ÇíÊ∏õ„Çâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            return false;
        }

        // ÈÄÅ‰ø°Ââç„Å´ÊúÄÁµÇÁ¢∫Ë™ç
        console.log('„Éï„Ç©„Éº„É†ÈÄÅ‰ø°Ë®±ÂèØ - „Ç´„ÉÜ„Ç¥„É™Êï∞:', checkedBoxes.length);
        return true;
    }

    // „Éö„Éº„Ç∏„É≠„Éº„ÉâÊôÇ„ÅÆÂàùÊúüÂåñ
    document.addEventListener("DOMContentLoaded", () => {
        // „ÅäÊ∞ó„Å´ÂÖ•„Çä„Ç¢„Ç§„Ç≥„É≥„ÅÆÂàùÊúüÂåñ
        const icon = document.getElementById("favorite-icon");
        const input = document.getElementById("favorite-input");
        if (icon && input) {
            icon.src = input.value === "true"
                ? "/images/icons/heart_active.svg"
                : "/images/icons/heart_off.svg";
            if (input.value === "true") {
                icon.classList.add("selected");
            }
        }

        // ÁîªÂÉè„Éó„É¨„Éì„É•„ÉºÊ©üËÉΩ„ÅÆÂàùÊúüÂåñ
        const imageInput = document.getElementById('image');
        if (imageInput) {
            imageInput.addEventListener('change', handleImagePreview);
        }

        // „Ç´„ÉÜ„Ç¥„É™„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        const categoryCheckboxes = document.querySelectorAll('input[name="categories"]');
        categoryCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', handleCategoryChange);
        });

        // „Éï„Ç©„Éº„É†ÈÄÅ‰ø°ÊôÇ„ÅÆ„Éê„É™„Éá„Éº„Ç∑„Éß„É≥
        const form = document.getElementById('recipe-form');
        if (form) {
            form.addEventListener('submit', validateForm);
        }

        // ÂàùÊúüÁä∂ÊÖã„ÅÆË°®Á§∫Êõ¥Êñ∞
        updateSelectedCategories();

        // „Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥Â§ñ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
        document.addEventListener('click', (e) => {
            const categorySelector = document.querySelector('.category-selector');
            const options = document.getElementById('category-options');
            const arrow = document.querySelector('.arrow');

            if (!categorySelector.contains(e.target)) {
                options.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        });

        // Enter „Ç≠„Éº„Åß„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„Çí„Éà„Ç∞„É´
        const selectTrigger = document.querySelector('.select-trigger');
        if (selectTrigger) {
            selectTrigger.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    toggleDropdown();
                }
            });
        }

        // „Éï„É©„ÉÉ„Ç∑„É•„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆËá™ÂãïÈùûË°®Á§∫
        const flashMessages = document.querySelectorAll('.flash-message');
        flashMessages.forEach(message => {
            setTimeout(() => {
                message.style.opacity = '0';
                message.style.transform = 'translateY(-10px)';
                setTimeout(() => {
                    if (message.parentNode) {
                        message.parentNode.removeChild(message);
                    }
                }, 300);
            }, 5000); // 5ÁßíÂæå„Å´ÈùûË°®Á§∫
        });

        console.log('„Éï„Ç©„Éº„É†ÂàùÊúüÂåñÂÆå‰∫Ü');
    });
</script>

</body>
</html>