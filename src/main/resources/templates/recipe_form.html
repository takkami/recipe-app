<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${recipe.id} != null ? 'レシピ編集' : 'レシピ追加'">レシピ追加</title>
    <link rel="stylesheet" href="/assets/css/sanitize.css">
    <link rel="stylesheet" href="/assets/css/style.css">
</head>
<body class="page-add">
<div class="container">
    <header class="top-navbar">
        <div class="title">RecipeApp</div>
    </header>

    <nav class="sidebar">
        <ul>
            <li><a href="/home" class="home-button"><img src="/images/icons/home.svg" alt="ホーム" /><span>ホーム</span></a></li>
            <li><img src="/images/icons/book.svg" alt="レシピ一覧" /><span>レシピ一覧</span></li>
            <li><a href="/recipes/favorites"><img src="/images/icons/heart.svg" alt="お気に入り"><span>お気に入り</span></a></li>
            <li><img src="/images/icons/category.svg" alt="カテゴリ" /><span>カテゴリ</span></li>
            <li><img src="/images/icons/user.svg" alt="ユーザー情報" /><span>ユーザー情報</span></li>
            <li><img src="/images/icons/interrogation.svg" alt="ヘルプ" /><span>ヘルプ</span></li>
            <li class="bottom"><img src="/images/icons/settings.svg" alt="設定" /><span>設定</span></li>
        </ul>
    </nav>

    <main class="main-content">
        <div class="section-header">
            <div class="section-title">
                <h1 th:text="${recipe.id} != null ? 'レシピを編集' : 'レシピを追加'">レシピを追加</h1>
            </div>
            <div class="add-button-container">
                <a href="/home" class="add-button back-button">
                    <span class="add-text">戻る</span>
                    <img src="/images/icons/back.svg" alt="戻る">
                </a>
            </div>
        </div>

        <div class="form-container">
            <!-- お気に入りボタンを右上に配置 -->
            <button type="button" class="favorite-toggle favorite-top-right" onclick="toggleFavorite(this)">
                <img id="favorite-icon"
                     th:src="${recipe.favorite} ? '/images/icons/heart_active.svg' : '/images/icons/heart_off.svg'"
                     th:classappend="${recipe.favorite} ? ' selected' : ''"
                     alt="お気に入り"
                     class="heart-image">
            </button>

            <!-- フラッシュメッセージ表示 -->
            <div th:if="${successMessage}" class="flash-message success-message">
                <span th:text="${successMessage}"></span>
            </div>
            <div th:if="${warningMessage}" class="flash-message warning-message">
                <span th:text="${warningMessage}"></span>
            </div>
            <div th:if="${errorMessage}" class="flash-message error-message">
                <span th:text="${errorMessage}"></span>
            </div>

            <form th:action="@{${recipe.id} != null ? '/recipes/update' : '/recipes/new'}" th:object="${recipe}" method="post" enctype="multipart/form-data" id="recipe-form">
                <!-- ID（編集時のみ） -->
                <input type="hidden" th:if="${recipe.id}" th:name="id" th:value="${recipe.id}" />

                <!-- お気に入りの値を保持する隠しフィールド -->
                <input type="hidden" th:name="favorite" th:value="${recipe.favorite}" id="favorite-input" />

                <div class="form-group">
                    <label for="title">タイトル</label>
                    <input type="text" id="title" th:name="title" th:value="${recipe.title}" required>
                </div>

                <div class="form-group">
                    <label for="image">レシピ画像</label>
                    <div class="file-input-wrapper">
                        <input type="file" id="image" name="image" accept="image/jpeg,image/jpg,image/png,image/gif,image/webp" />
                        📷 画像を選択
                    </div>

                    <!-- 編集時の既存画像表示と削除 -->
                    <div th:if="${recipe.imagePath}" class="image-preview-container" id="current-image-wrapper">
                        <span class="current-image-label">現在の画像:</span>
                        <img th:src="@{${recipe.imagePath}}" alt="現在の画像" class="image-preview" id="current-image" />
                        <button type="button" class="image-remove" onclick="removeCurrentImage()">×</button>
                        <input type="hidden" name="deleteCurrentImage" id="deleteCurrentImage" value="false" />
                    </div>

                    <!-- 新しい画像のプレビュー -->
                    <div class="image-preview-container" id="preview-container" style="display: none;">
                        <span class="current-image-label">選択した画像:</span>
                        <img id="image-preview" class="image-preview" alt="画像プレビュー" />
                        <button type="button" class="image-remove" onclick="removeImagePreview()">×</button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="ingredients">材料</label>
                    <textarea id="ingredients" th:name="ingredients" th:text="${recipe.ingredients}"></textarea>
                </div>

                <div class="form-group">
                    <label for="instructions">作り方</label>
                    <textarea id="instructions" th:name="instructions" th:text="${recipe.instructions}"></textarea>
                </div>

                <div class="form-group">
                    <label for="reference">参考動画・サイト（URL）</label>
                    <input type="url" id="reference" th:name="reference" th:value="${recipe.reference}" placeholder="https://example.com">
                </div>

                <div class="form-group">
                    <label for="category-select">カテゴリ（最大3つまで選択可）</label>
                    <div class="category-selector">
                        <div class="custom-select">
                            <div class="select-trigger" onclick="toggleDropdown()">
                                <span id="selected-categories">カテゴリを選択してください</span>
                                <span class="arrow">▼</span>
                            </div>
                            <div class="select-options" id="category-options">
                                <label class="option"><input type="checkbox" name="categories" value="和食" th:checked="${recipe.categories != null and recipe.categories.contains('和食')}"> 和食</label>
                                <label class="option"><input type="checkbox" name="categories" value="洋食" th:checked="${recipe.categories != null and recipe.categories.contains('洋食')}"> 洋食</label>
                                <label class="option"><input type="checkbox" name="categories" value="中華" th:checked="${recipe.categories != null and recipe.categories.contains('中華')}"> 中華</label>
                                <label class="option"><input type="checkbox" name="categories" value="麺類" th:checked="${recipe.categories != null and recipe.categories.contains('麺類')}"> 麺類</label>
                                <label class="option"><input type="checkbox" name="categories" value="スープ" th:checked="${recipe.categories != null and recipe.categories.contains('スープ')}"> スープ</label>
                                <label class="option"><input type="checkbox" name="categories" value="サラダ" th:checked="${recipe.categories != null and recipe.categories.contains('サラダ')}"> サラダ</label>
                                <label class="option"><input type="checkbox" name="categories" value="おつまみ" th:checked="${recipe.categories != null and recipe.categories.contains('おつまみ')}"> おつまみ</label>
                                <label class="option"><input type="checkbox" name="categories" value="デザート" th:checked="${recipe.categories != null and recipe.categories.contains('デザート')}"> デザート</label>
                                <label class="option"><input type="checkbox" name="categories" value="時短" th:checked="${recipe.categories != null and recipe.categories.contains('時短')}"> 時短</label>
                                <label class="option"><input type="checkbox" name="categories" value="ヘルシー" th:checked="${recipe.categories != null and recipe.categories.contains('ヘルシー')}"> ヘルシー</label>
                                <label class="option"><input type="checkbox" name="categories" value="その他" th:checked="${recipe.categories != null and recipe.categories.contains('その他')}"> その他</label>
                            </div>
                        </div>
                        <!-- カテゴリ制限メッセージ -->
                        <div id="category-limit-message" class="category-limit-message" style="display: none;">
                            カテゴリの選択は3つまでです。
                        </div>
                        <div class="selected-tags" id="selected-tags"></div>
                    </div>
                </div>

                <div class="button-wrapper">
                    <button type="submit" class="submit-button" th:text="${recipe.id} != null ? '更新' : '登録'" id="submit-btn">登録</button>
                </div>
            </form>
        </div>
    </main>
</div>

<script>
    // カテゴリ制限の設定（3つに変更）
    const MAX_CATEGORIES = 3;
    let formSubmissionBlocked = false;

    // 新しい画像プレビュー処理
    function handleImagePreview(event) {
        const file = event.target.files[0];
        const previewContainer = document.getElementById('preview-container');
        const previewImage = document.getElementById('image-preview');

        if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImage.src = e.target.result;
                previewContainer.style.display = 'block';
            };
            reader.readAsDataURL(file);
        } else {
            previewContainer.style.display = 'none';
            previewImage.src = '';
        }
    }

    // 新しく選んだ画像を削除（ファイルインプットをリセット）
    function removeImagePreview() {
        const fileInput = document.getElementById('image');
        const previewContainer = document.getElementById('preview-container');
        const previewImage = document.getElementById('image-preview');

        const newInput = fileInput.cloneNode(true);
        newInput.value = '';
        newInput.addEventListener('change', handleImagePreview);
        fileInput.parentNode.replaceChild(newInput, fileInput);

        previewImage.src = '';
        previewContainer.style.display = 'none';
    }

    // 既存の画像を削除（編集時）
    function removeCurrentImage() {
        const currentImage = document.getElementById('current-image');
        const currentWrapper = document.getElementById('current-image-wrapper');
        const deleteInput = document.getElementById('deleteCurrentImage');

        currentWrapper.style.display = 'none';
        deleteInput.value = 'true';
    }

    function toggleFavorite(button) {
        const icon = document.getElementById('favorite-icon');
        const input = document.getElementById('favorite-input');
        const isSelected = icon.classList.toggle('selected');
        input.value = isSelected ? "true" : "false";
        icon.src = isSelected ? "/images/icons/heart_active.svg" : "/images/icons/heart_off.svg";
    }

    // カテゴリセレクターの機能
    function toggleDropdown() {
        const options = document.getElementById('category-options');
        options.style.display = options.style.display === 'block' ? 'none' : 'block';
    }

    // カテゴリ選択状況を更新（強化版）
    function updateSelectedCategories() {
        const checkboxes = document.querySelectorAll('input[name="categories"]:checked');
        const selectedText = document.getElementById('selected-categories');
        const selectedTags = document.getElementById('selected-tags');
        const limitMessage = document.getElementById('category-limit-message');
        const submitBtn = document.getElementById('submit-btn');
        const allCheckboxes = document.querySelectorAll('input[name="categories"]');

        // 選択状況の表示更新
        if (checkboxes.length === 0) {
            selectedText.textContent = 'カテゴリを選択してください';
            selectedTags.innerHTML = '';
            limitMessage.style.display = 'none';
            formSubmissionBlocked = false;
        } else {
            selectedText.textContent = `${checkboxes.length}個のカテゴリを選択中`;
            selectedTags.innerHTML = '';

            // 制限チェック（厳格化）
            if (checkboxes.length > MAX_CATEGORIES) {
                limitMessage.style.display = 'block';
                limitMessage.textContent = `カテゴリは${MAX_CATEGORIES}つまでしか選択できません。現在${checkboxes.length}つ選択されています。`;
                limitMessage.className = 'category-limit-message error';
                formSubmissionBlocked = true;

                // 送信ボタンを無効化
                submitBtn.style.opacity = '0.5';
                submitBtn.style.cursor = 'not-allowed';
                submitBtn.title = 'カテゴリの選択数を減らしてください';

                // 未選択のチェックボックスを無効化
                allCheckboxes.forEach(checkbox => {
                    if (!checkbox.checked) {
                        checkbox.disabled = true;
                        checkbox.parentElement.classList.add('disabled');
                    }
                });
            } else if (checkboxes.length === MAX_CATEGORIES) {
                limitMessage.style.display = 'block';
                limitMessage.textContent = `カテゴリを${MAX_CATEGORIES}つ選択しました（上限）`;
                limitMessage.className = 'category-limit-message';
                formSubmissionBlocked = false;

                // 送信ボタンを有効化
                submitBtn.style.opacity = '1';
                submitBtn.style.cursor = 'pointer';
                submitBtn.title = '';

                // 未選択のチェックボックスを無効化
                allCheckboxes.forEach(checkbox => {
                    if (!checkbox.checked) {
                        checkbox.disabled = true;
                        checkbox.parentElement.classList.add('disabled');
                    } else {
                        checkbox.disabled = false;
                        checkbox.parentElement.classList.remove('disabled');
                    }
                });
            } else {
                limitMessage.style.display = 'none';
                formSubmissionBlocked = false;

                // 送信ボタンを有効化
                submitBtn.style.opacity = '1';
                submitBtn.style.cursor = 'pointer';
                submitBtn.title = '';

                // 全チェックボックスを有効化
                allCheckboxes.forEach(checkbox => {
                    checkbox.disabled = false;
                    checkbox.parentElement.classList.remove('disabled');
                });
            }

            // 選択されたタグの表示
            checkboxes.forEach(checkbox => {
                const tag = document.createElement('span');
                tag.className = `category-tag ${checkbox.value}`;
                tag.textContent = checkbox.value;

                const removeBtn = document.createElement('span');
                removeBtn.className = 'remove-tag';
                removeBtn.textContent = '×';
                removeBtn.onclick = () => {
                    checkbox.checked = false;
                    updateSelectedCategories();
                };

                tag.appendChild(removeBtn);
                selectedTags.appendChild(tag);
            });
        }
    }

    // カテゴリチェックボックスのchange処理（強化版）
    function handleCategoryChange(event) {
        // 即座に状況を更新
        updateSelectedCategories();
    }

    // フォーム送信前のバリデーション
    function validateForm(event) {
        const checkedBoxes = document.querySelectorAll('input[name="categories"]:checked');

        if (checkedBoxes.length > MAX_CATEGORIES) {
            event.preventDefault();
            alert(`カテゴリが${checkedBoxes.length}つ選択されているため登録できませんでした。カテゴリは${MAX_CATEGORIES}つまでしか選択できません。`);
            return false;
        }

        if (formSubmissionBlocked) {
            event.preventDefault();
            alert('カテゴリの選択数が上限を超えています。選択を減らしてください。');
            return false;
        }

        return true;
    }

    // ページロード時の初期化
    document.addEventListener("DOMContentLoaded", () => {
        // お気に入りアイコンの初期化
        const icon = document.getElementById("favorite-icon");
        const input = document.getElementById("favorite-input");
        if (icon && input) {
            icon.src = input.value === "true"
                ? "/images/icons/heart_active.svg"
                : "/images/icons/heart_off.svg";
            if (input.value === "true") {
                icon.classList.add("selected");
            }
        }

        // 画像プレビュー機能の初期化
        const imageInput = document.getElementById('image');
        if (imageInput) {
            imageInput.addEventListener('change', handleImagePreview);
        }

        // カテゴリチェックボックスのイベントリスナー
        const categoryCheckboxes = document.querySelectorAll('input[name="categories"]');
        categoryCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', handleCategoryChange);
        });

        // フォーム送信時のバリデーション
        const form = document.getElementById('recipe-form');
        if (form) {
            form.addEventListener('submit', validateForm);
        }

        // 初期状態の表示更新
        updateSelectedCategories();

        // ドロップダウン外クリックで閉じる
        document.addEventListener('click', (e) => {
            const categorySelector = document.querySelector('.category-selector');
            if (!categorySelector.contains(e.target)) {
                document.getElementById('category-options').style.display = 'none';
            }
        });

        // フラッシュメッセージの自動非表示
        const flashMessages = document.querySelectorAll('.flash-message');
        flashMessages.forEach(message => {
            setTimeout(() => {
                message.style.opacity = '0';
                message.style.transform = 'translateY(-10px)';
                setTimeout(() => {
                    if (message.parentNode) {
                        message.parentNode.removeChild(message);
                    }
                }, 300);
            }, 5000); // 5秒後に非表示
        });
    });
</script>

</body>
</html>